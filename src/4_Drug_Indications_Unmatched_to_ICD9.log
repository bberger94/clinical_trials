
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   14.2   Copyright 1985-2015 StataCorp LP
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     MP - Parallel Edition            College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

18-user 8-core Stata network perpetual license:
       Serial number:  501406201034
         Licensed to:  National Bureau of Economic Research
                       Cambridge, MA 02138

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.
      3.  More than 2 billion observations are allowed; see help obs_advice.
      4.  Maximum number of variables is set to 5000; see help set_maxvar.


running /disk/admin/Linux-local/stata14/sysprofile.do ...

. do 4_Drug_Indications_Unmatched_to_ICD9.do 

. /****************************************************************************
> *******
> File        : 1_Drug_Indications_Unmatched_to_ICD9.do
> Authors     : Alice Ndikumana
> Created     : 19 Jul 2016
> Modified    : 19 Jul 2016
> Description : Using an excel export of all Cortellis drugs as of 7/19, 9am, i
> dentify
> indications that are in Cortellis but not included in the crosswalk from Cort
> ellis
> indications to ICD-9 codes recieved from John.
> *****************************************************************************
> ******/
. 
. do setup.do

. global raw = "../data/raw"

. global interim = "../data/interim"

. global processed = "../data/processed"

. 
end of do-file

. 
. * Stata-fies first 7 excel files from 2005-2015, then 2 excel files from 1995
> -2004
. forvalues i=0/12{
  2. clear
  3. import delimited "$raw/Drugs_Results(`i').csv"
  4. save $interim/Results-`i'.dta, replace
  5. }
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-0.dta not found)
file ../data/interim/Results-0.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-1.dta not found)
file ../data/interim/Results-1.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-2.dta not found)
file ../data/interim/Results-2.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-3.dta not found)
file ../data/interim/Results-3.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-4.dta not found)
file ../data/interim/Results-4.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-5.dta not found)
file ../data/interim/Results-5.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-6.dta not found)
file ../data/interim/Results-6.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-7.dta not found)
file ../data/interim/Results-7.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-8.dta not found)
file ../data/interim/Results-8.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-9.dta not found)
file ../data/interim/Results-9.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-10.dta not found)
file ../data/interim/Results-10.dta saved
(18 vars, 5,000 obs)
(note: file ../data/interim/Results-11.dta not found)
file ../data/interim/Results-11.dta saved
(18 vars, 4,482 obs)
(note: file ../data/interim/Results-12.dta not found)
file ../data/interim/Results-12.dta saved

. 
. * Merges excel files into a single STATA file
. use $interim/Results-0.dta,clear

. forvalues i=1/12{
  2. append using $interim/Results-`i'.dta
  3. }
(note: variable drugname was str246, now str283 to accommodate using data's
       values)
(note: variable activecompanies was str453, now str491 to accommodate using
       data's values)
(note: variable otherdrugnames was str956, now str1113 to accommodate using
       data's values)
(note: variable extract was str520, now str523 to accommodate using data's
       values)
(note: variable targetbasedactions was str414, now str452 to accommodate
       using data's values)
(note: variable originatorcompany was str94, now str96 to accommodate using
       data's values)
(note: variable inactivecompanies was str277, now str308 to accommodate using
       data's values)
(note: variable extract was str523, now str524 to accommodate using data's
       values)
(note: variable originatorcompany was str96, now str99 to accommodate using
       data's values)
(note: variable otherdrugnames was str1113, now str1372 to accommodate using
       data's values)
(note: variable otheractions was str247, now str261 to accommodate using
       data's values)

. save $interim/Results-all.dta, replace
(note: file ../data/interim/Results-all.dta not found)
file ../data/interim/Results-all.dta saved

. 
. *generate a key for drug names, to be used to match indications back to drugs
. keep drugname

. gen id=_n

. save "$interim/drug-id.dta", replace
(note: file ../data/interim/drug-id.dta not found)
file ../data/interim/drug-id.dta saved

. clear

. 
. * keep drug indications, drop all other variables
. use "$interim/Results-all.dta"

. keep activein inactivein

. gen id=_n

. 
. * create unduplicated list of drug indications
. * combine the active and inactive indications variables
. gen indication = active+";"+inactive

. keep ind id

. * split the indications and reshape to create a list of indications
. split ind, p(";")
variables created as string: indication1indication15indication29indication43ind
> ication57
indication2   indication16  indication30  indication44  indication58
indication3   indication17  indication31  indication45  indication59
indication4   indication18  indication32  indication46  indication60
indication5   indication19  indication33  indication47  indication61
indication6   indication20  indication34  indication48  indication62
indication7   indication21  indication35  indication49  indication63
indication8   indication22  indication36  indication50  indication64
indication9   indication23  indication37  indication51  indication65
indication10  indication24  indication38  indication52  indication66
indication11  indication25  indication39  indication53  indication67
indication12  indication26  indication40  indication54
indication13  indication27  indication41  indication55
indication14  indication28  indication42  indication56

. drop indication

. reshape long indication, i(id) j(j)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26
>  27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 5
> 2 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                    64482   -> 4.3e+06
Number of variables                  68   ->       3
j variable (67 values)                    ->   j
xij variables:
indication1 indication2 ... indication67  ->   indication
-----------------------------------------------------------------------------

. * drop empty indications
. drop if ind==""
(4,214,574 observations deleted)

. replace ind = trim(ind)
(38,138 real changes made)

. replace ind = lower(ind)
(105,720 real changes made)

. 
. * save indication key, to be used to match indications back to drugs
. merge m:1 id using "$interim/drug-id.dta"

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           105,720  (_merge==3)
    -----------------------------------------

. drop _merge

. save $interim/drug_indication_key.dta, replace
(note: file ../data/interim/drug_indication_key.dta not found)
file ../data/interim/drug_indication_key.dta saved

. 
. * drop duplicate indications
. keep ind

. duplicates drop

Duplicates in terms of all variables

(103,666 observations deleted)

. 
. * match variable name to enable comparison to drug indication key
. rename ind indicationname

. 
. * Compress and save list of unique Cortellis drug indications
. compress
  (0 bytes saved)

. save "$interim/List of Cortellis_Drug_Indications_as_of_19Jul2016.dta", repla
> ce
(note: file ../data/interim/List of Cortellis_Drug_Indications_as_of_19Jul2016.
> dta not found)
file ../data/interim/List of Cortellis_Drug_Indications_as_of_19Jul2016.dta sav
> ed

. 
. 
. * merge with Cortellis Drug Inidcations Key from Josh Krieger
. preserve

.   import delimited "$raw/CortellisDrugsIndicationsKey.txt", delimiter("|") va
> rnames(1) clear
(2 vars, 1,941 obs)

.   local path "$interim/CortellisDrugsIndicationsKey.dta"

.   save `path', replace
(note: file ../data/interim/CortellisDrugsIndicationsKey.dta not found)
file ../data/interim/CortellisDrugsIndicationsKey.dta saved

. restore

. merge 1:1 indicationname using "`path'"

    Result                           # of obs.
    -----------------------------------------
    not matched                         3,995
        from master                     2,054  (_merge==1)
        from using                      1,941  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------

. 
. * create new variable that clarifies if the Cortellis indication is included 
> in the indication key
. gen match_to_icd9_key=_m

. tostring match_to_icd9, replace
match_to_icd9_key was float now str1

. replace match_to_icd9="Cortellis indication, included in indication key" if _
> m==3
(0 real changes made)

. replace match_to_icd9="Cortellis indication, not included in indication key" 
> if _m==1
variable match_to_icd9_key was str1 now str52
(2,054 real changes made)

. replace match_to_icd9="Not a Cortellis indication, included in indication key
> " if _m==2
variable match_to_icd9_key was str52 now str54
(1,941 real changes made)

. 
. * drop _merge variable and label new variable
. drop _m

. label var match "Match to ICD9 Key"

. 
. * Now match list of indications with P2 conditions
. * frist, rename the indicationname variable to condition and make all entries
>  lowercase
. rename indicationname condition

. replace con=lower(con)
(1,941 real changes made)

. 
. * then, merge the list of P2 conditions
. * TODO: File does not exist: P2_conditions.dta
. 
. // Clean up data so it can be merged with P2_conditions
.   generate test = "Cortellis indication, not included in indication key" if m
> issing(indicationsid)
(1,941 missing values generated)

.   replace test = "Not a Cortellis indication, included in indication key" if 
> !missing(indicationsid)
variable test was str52 now str54
(1,941 real changes made)

.   assert test == match_to_icd9_key

.   drop test match_to_icd9_key

. 
.   sort condition indicationsid

.   generate id = _n

.   egen start = min(id), by(condition)

.   replace id = id - start
(3,995 real changes made)

.   drop start

.   reshape wide indicationsid, i(condition) j(id)
(note: j = 0 1)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                     3995   ->    2060
Number of variables                   3   ->       3
j variable (2 values)                id   ->   (dropped)
xij variables:
                          indicationsid   ->   indicationsid0 indicationsid1
-----------------------------------------------------------------------------

.   assert missing(indicationsid1)

.   drop indicationsid1

.   rename indicationsid0 indicationsid

. 
. merge 1:1 condition using "$raw/P2_conditions.dta"

    Result                           # of obs.
    -----------------------------------------
    not matched                           718
        from master                       453  (_merge==1)
        from using                        265  (_merge==2)

    matched                             1,607  (_merge==3)
    -----------------------------------------

. 
. * create new variable that clarifies if the Cortellis condition is included i
> n the list of indications
. gen match_to_P2=_m

. tostring match_to_P, replace
match_to_P2 was float now str1

. replace match_to_P="Cortellis condition with matching indication" if _m==3
variable match_to_P2 was str1 now str44
(1,607 real changes made)

. replace match_to_P="Cortellis condition without matching indication" if _m==2
variable match_to_P2 was str44 now str47
(265 real changes made)

. replace match_to_P="Indication without matching Cortellis condition" if _m==1
(453 real changes made)

. 
. * drop _merge variable and label new variable
. drop _m

. label var match_to_P "Match to P2 Cortellis Conditions"

. 
. * now match indications back to drug names
. rename con indication

. merge 1:m indication using "$interim/drug_indication_key.dta"

    Result                           # of obs.
    -----------------------------------------
    not matched                           271
        from master                       271  (_merge==1)
        from using                          0  (_merge==2)

    matched                           105,720  (_merge==3)
    -----------------------------------------

. label var id "ID"

. drop _m

. 
. *rename condition variable to denote that the list includes indications and o
> r conditions
. rename indication conditions_andor_indications

. label var con "Conditions and/or Indications"

. 
. save "$interim/Cortellis_Drug_IndicationsandConditions_all.dta", replace
(note: file ../data/interim/Cortellis_Drug_IndicationsandConditions_all.dta not
>  found)
file ../data/interim/Cortellis_Drug_IndicationsandConditions_all.dta saved

. 
end of do-file
